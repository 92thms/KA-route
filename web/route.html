<!doctype html>
<html lang="de">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kleinanzeigen Routen-Suche</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
  :root{
    --bg:#121212;--fg:#e0e0e0;--card:#1e1e1e;--border:#333;--accent:#1e66f5;--ok:#43d17c;--err:#ef5350;
  }
  *{box-sizing:border-box}
  body{margin:0;font:14px/1.4 system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--fg)}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}
  /* Links im Darkmode */
  a, a:visited{color:#b4c7ff;text-decoration:none}
  a:hover{color:#d5e2ff;text-decoration:underline}

  /* App Header */
  .app-header{
    padding:20px 12px;
    background:var(--card);
    border-bottom:2px solid var(--accent);
    text-align:center;
  }
  .app-header h1{
    margin:0 0 6px;
    font-size:22px;
    font-weight:800;
    color:#fff;
  }
  .app-header p{
    margin:0;
    font-size:14px;
    color:#ccc;
  }

  /* Header / Inputs */
  header{
    display:flex;flex-wrap:wrap;gap:10px;padding:12px;border-bottom:1px solid var(--border);background:var(--card)
  }
  header .group{display:flex;flex-direction:column;gap:4px;flex:1;min-width:240px}
  input,button{
    padding:10px 12px;border:1px solid var(--border);border-radius:10px;font:inherit;background:#0e0e0e;color:var(--fg)
  }
  input:focus{outline:2px solid #2a6dfb}
  button{cursor:pointer;background:var(--accent);color:#fff;border:none;font-weight:700}

  /* Suggest / Autocomplete */
  .suggest{position:relative}
  .suggest ul{
    position:absolute;left:0;right:0;top:calc(100% + 6px);z-index:999;margin:0;list-style:none;padding:6px;border:1px solid var(--border);
    background:#0e0e0e;border-radius:10px;max-height:240px;overflow:auto;box-shadow:0 6px 18px rgba(0,0,0,.35)
  }
  .suggest li{padding:8px 10px;border-radius:8px;cursor:pointer}
  .suggest li:hover{background:#1b1b1b}

  /* Map + progress */
  #map-box{padding:12px}
  #map-progress{
    width:100%;
    height:22px;
    background:#202020;
    border:1px solid var(--border);
    border-radius:8px;
    overflow:hidden;
    margin:0 0 10px;
    position:relative;
  }
#map-progress .bar{
  height:100%;
  width:0;
  transition:width .2s linear;
  background:#2563eb;                 /* Basisfarbe */
}
/* läuft + animiert */
#map-progress .bar.active{
  background:
    repeating-linear-gradient(
      45deg,
      #2563eb 0 12px,
      #3b82f6 12px 24px
    );
  animation: stripe 1.2s linear infinite;
}
/* fertig (grün, keine Animation) */
#map-progress .bar.done{
  background:#22c55e;
  animation:none;
}
/* abgebrochen (rot, keine Animation) */
#map-progress .bar.aborted{
  background:#ef4444;
  animation:none;
}
  }
  @keyframes stripe{
    from{ background-position:0 0; }
    to  { background-position:48px 0; }
  }
  @media (prefers-reduced-motion: reduce){
    #map-progress .bar{ animation:none; }
  }
  #map-progress .pct{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    font-weight:700; color:#fff; text-shadow:0 1px 1px #000; pointer-events:none;
  }
  #map{height:50vh;width:100%;border:1px solid var(--border);border-radius:10px}

  /* Panel + Gruppen-Boxen */
  #panel{display:flex;flex-direction:column;gap:10px;padding:12px}
  #results{border:1px solid var(--border);border-radius:10px;padding:12px;max-height:28vh;overflow:auto;background:var(--card)}
  #results strong{display:block;margin-bottom:6px}
  .row{padding:6px 0;border-bottom:1px dashed #444}.row:last-child{border-bottom:0}
  .muted{color:#aaa}
  .thumb{width:256px;height:256px;object-fit:cover;border-radius:6px;margin-right:8px;vertical-align:middle}

  /* Auf-/zuklappbare Ortsgruppen + Galerie */
  #results .groupbox{border:1px solid var(--border);border-radius:10px;margin:10px 0;overflow:hidden;background:#151515}
  #results .groupbox summary{
    cursor:pointer;padding:10px 12px;font-weight:700;list-style:none;display:flex;justify-content:space-between;align-items:center
  }
  #results .groupbox summary::marker, #results .groupbox summary::-webkit-details-marker{display:none}
  #results .groupbox .badge{
    background:var(--accent);color:#fff;border-radius:999px;padding:.1rem .5rem;font-size:12px;font-weight:800
  }
  #results .groupbox .gbody{padding:6px 12px}

  .gallery {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 8px;
  }
  .gallery-item {
    flex: 0 1 calc(33% - 12px); /* 3 pro Zeile (Desktop) */
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px;
    overflow: hidden;
  }
  .gallery-item img {
    width: 100%;
    height: 256px;
    object-fit: cover;
    border-radius: 6px;
    margin-bottom: 6px;
  }
  .gallery-item strong {
    display: block;
    margin-bottom: 4px;
    font-size: 14px;
  }
  .gallery-item .muted {
    font-size: 12px;
  }
  @media (max-width: 768px){
    .gallery-item { flex: 0 1 calc(50% - 12px); } /* 2 pro Zeile (Mobile) */
  }

  /* Status pretty with <details> */
  details{background:var(--card);border:1px solid var(--border);border-radius:10px}
  summary{cursor:pointer;padding:10px 12px;font-weight:700;border-bottom:1px solid var(--border);list-style:none}
  summary::marker,summary::-webkit-details-marker{display:none}
  #status{padding:12px;max-height:260px;overflow:auto}
  .ok{color:var(--ok)} .err{color:var(--err)}

  /* Popups Darkmode + Scrollbar */
  .leaflet-popup-content-wrapper{
    background: var(--card);
    color: var(--fg);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: 0 8px 28px rgba(0,0,0,.45);
  }
  .leaflet-popup-tip{
    background: var(--card);
    border: 1px solid var(--border);
  }
  .leaflet-popup-content{
    max-height: 260px;
    overflow: auto;
    color: var(--fg);
  }
  .leaflet-popup-content a{
    color: #9ec1ff;
    text-decoration: none;
    font-weight: 700;
  }
  .leaflet-popup-content a:hover{ text-decoration: underline; }
  .leaflet-popup-content img{ border-radius: 8px; max-width: 180px; height: auto; }

  /* dunkle Scrollbar */
  .leaflet-popup-content::-webkit-scrollbar{width:10px}
  .leaflet-popup-content::-webkit-scrollbar-track{background:#0c0c0c;border-radius:10px}
  .leaflet-popup-content::-webkit-scrollbar-thumb{background:#2a2a2a;border-radius:10px;border:2px solid #0c0c0c}
  .leaflet-popup-content::-webkit-scrollbar-thumb:hover{background:#3a3a3a}
  .leaflet-popup-content{ scrollbar-width: thin; scrollbar-color: #2a2a2a #0c0c0c; }

  /* HARD mobile layout */
  @media (max-width: 768px){
    header{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    header .group{min-width:100%}
    input,button{font-size:16px;padding:14px}
    #btnRun{width:100%}
    #map{height:45vh}
    #results{max-height:32vh}
  }
</style>
<body>

<div class="app-header">
  <h1>Kleinanzeigen Routensuche</h1>
  <p>Berechne eine Route zwischen Start und Ziel, finde Inserate entlang der Strecke und sieh sie direkt auf der Karte.</p>
</div>

<header>
  <div class="group suggest">
    <label for="start">Start</label>
    <input id="start" placeholder="Adresse/Ort eingeben" autocomplete="off">
    <ul id="start-suggest" hidden></ul>
  </div>
  <div class="group suggest">
    <label for="ziel">Ziel</label>
    <input id="ziel" placeholder="Adresse/Ort eingeben" autocomplete="off">
    <ul id="ziel-suggest" hidden></ul>
  </div>
  <div class="group">
    <label for="query">Suchbegriff</label>
    <input id="query" placeholder="Suchbegriff">
  </div>
  <div class="group">
    <label>&nbsp;</label>
    <button id="btnRun">Route berechnen &amp; suchen</button>
  </div>
</header>

<div id="map-box">
  <div id="map-progress"><div id="progressBar" class="bar"></div><span id="progressText" class="pct">0%</span></div>
  <div id="map"></div>
</div>

<div id="panel">
  <div id="results"><strong>Ergebnisliste</strong><div class="row">Noch keine Suche.</div></div>
  <details id="statusWrap">
    <summary>Status ▼</summary>
    <div id="status"><strong>Status</strong> Bereit.</div>
  </details>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const ORS_APIKEY = "5b3ce3597851110001cf6248e559d761d820441ba395eb067a726109";
const NOMINATIM_HEADERS = { "Accept":"application/json", "Accept-Language":"de" };

// Map
const map = L.map('map').setView([48.7, 9.18], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
let routeLayer;
const resultMarkers = L.layerGroup().addTo(map);

// Shorthands
const $=sel=>document.querySelector(sel);
// Progress-Helfer
function setProgress(pct){
  const bar = $("#progressBar"), txt = $("#progressText");
  const clamped = Math.max(0, Math.min(100, pct|0));
  bar.style.width = clamped + "%";
  txt.textContent = clamped + "%";
}
function setProgressState(state /* 'active' | 'done' | 'aborted' */, msg){
  const bar = $("#progressBar"), txt = $("#progressText");
  bar.classList.remove("active","done","aborted");
  if(state) bar.classList.add(state);
  if(msg) txt.textContent = msg;
}

// -------- Status --------
function setStatus(msg,isErr=false){const s=$("#status");const line=document.createElement("div");line.textContent=msg;line.className=isErr?"err":"ok";s.appendChild(line);}
function resetStatus(){const s=$("#status");s.innerHTML="<strong>Status</strong> ";}

// -------- Ergebnisliste: gruppiert + Galerie --------
const groups = new Map(); // key -> details element

function ensureGroup(loc){
  const key=loc||"Unbekannt";
  if(groups.has(key)) return groups.get(key);
  const wrap=document.createElement('details');
  wrap.className='groupbox'; wrap.open=false;
  wrap.innerHTML=`<summary>${key} <span class="badge" data-count="0">0</span></summary><div class="gbody"><div class="gallery"></div></div>`;
  $("#results").appendChild(wrap);
  groups.set(key, wrap);
  return wrap;
}
function clearResults(){
  const r=$("#results");
  r.innerHTML="<strong>Ergebnisliste</strong>";
  r.dataset.cleared="1";
  resultMarkers.clearLayers();markerClusters.length=0;
  groups.clear();
}
function addResultGalleryGroup(loc, cardHtml){
  const results = $("#results");
  if(results.dataset.cleared!="1"){
    results.innerHTML="<strong>Ergebnisliste</strong>";
    results.dataset.cleared="1";
  }
  const box=ensureGroup(loc);
  const gallery=box.querySelector('.gallery');
  const item=document.createElement('div');
  item.className='gallery-item';
  item.innerHTML=cardHtml;
  gallery.appendChild(item);
  const badge=box.querySelector('.badge');
  badge.textContent=String(Number(badge.textContent)+1);
}

// -------- Debounce & Autocomplete (auf DE beschränkt) --------
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}
async function geocodeSuggest(q){
  if(!q||q.length<3) return [];
  const url=`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&countrycodes=de&q=${encodeURIComponent(q)}`;
  const res=await fetch(url,{headers:NOMINATIM_HEADERS});
  if(!res.ok) throw new Error("Nominatim Suggest HTTP "+res.status);
  return res.json();
}
function bindSuggest(inputSel,listSel){
  const input=$(inputSel), list=$(listSel);
  const render=items=>{
    if(!items.length){list.hidden=true;list.innerHTML="";return;}
    list.innerHTML=items.map(i=>`<li data-lat="${i.lat}" data-lon="${i.lon}">${i.display_name}</li>`).join("");
    list.hidden=false;
  };
  const onPick=li=>{
    input.value=li.textContent;
    input.dataset.lat=li.getAttribute("data-lat");
    input.dataset.lon=li.getAttribute("data-lon");
    list.hidden=true;
  };
  list.addEventListener("click",e=>{const li=e.target.closest("li");if(li)onPick(li);});
  input.addEventListener("input",debounce(async()=>{
    try{ render(await geocodeSuggest(input.value)); }
    catch(err){ setStatus("Autocomplete-Fehler: "+err.message,true); }
  },250));
  input.addEventListener("blur",()=>setTimeout(()=>list.hidden=true,150));
}
bindSuggest("#start","#start-suggest");
bindSuggest("#ziel","#ziel-suggest");

// -------- Distanz-Helpers --------
function haversine(lat1,lon1,lat2,lon2){
  const R=6371e3, toRad=d=>d*Math.PI/180;
  const φ1=toRad(lat1), φ2=toRad(lat2), dφ=toRad(lat2-lat1), dλ=toRad(lon2-lon1);
  const a=Math.sin(dφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// --- Marker-Gruppierung (nahe beieinander) ---
const markerClusters = []; // {lat, lon, marker, items: [html]}
function distMeters(aLat, aLon, bLat, bLon){
  const R=6371e3, toRad=d=>d*Math.PI/180;
  const dφ=toRad(bLat-aLat), dλ=toRad(bLon-aLon);
  const φ1=toRad(aLat), φ2=toRad(bLat);
  const x=Math.sin(dφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;
  return 2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
function addListingToClusters(lat, lon, itemHtml, titleForPopup="Anzeigen in der Nähe"){
  const existing = markerClusters.find(c => distMeters(c.lat,c.lon,lat,lon) < 200); // 200 m
  if(existing){
    existing.items.push(itemHtml);
    const list = `<strong>${titleForPopup}</strong><ul style="padding-left:18px;margin:6px 0">
      ${existing.items.map(x=>`<li style="margin:4px 0">${x}</li>`).join('')}
    </ul>`;
    existing.marker.setPopupContent(list);
    return existing.marker;
  }else{
    const marker = L.marker([lat,lon],{icon:greenIcon}).addTo(resultMarkers);
    const list = `<strong>${titleForPopup}</strong><ul style="padding-left:18px;margin:6px 0">
      <li style="margin:4px 0">${itemHtml}</li>
    </ul>`;
    marker.bindPopup(list);
    markerClusters.push({lat,lon,marker,items:[itemHtml]});
    return marker;
  }
}

// -------- Proxy fetch --------
async function fetchViaProxy(url){
  const prox=`/proxy?u=${url}`;
  const r=await fetch(prox,{credentials:'omit',cache:'no-store'});
  if(!r.ok){const txt=await r.text().catch(()=>String(r.status));throw new Error(`Proxy HTTP ${r.status}${txt?": "+txt.slice(0,80):""}`);}
  return r.text();
}

// -------- Preisformat --------
function formatPrice(p){
  if(!p)return"VB oder Kostenlos";
  const n=String(p).trim(); if(n==="")return"VB oder Kostenlos";
  if(/[€]/.test(n))return n;
  const digits=n.replace(/[^0-9]/g,''); if(!digits)return"VB oder Kostenlos";
  return new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(Number(digits));
}

// -------- Parsing --------
function cityFromAddr(a){return a?.city||a?.town||a?.village||a?.municipality||a?.county||'';}
function safeParse(json){try{return JSON.parse(json);}catch(_){return null;}}
async function parseListingDetails(html){
  const doc=new DOMParser().parseFromString(html,'text/html');
  const title=doc.querySelector('meta[property="og:title"]')?.content||doc.title||null;
  let image=doc.querySelector('meta[property="og:image"]')?.content||null;
  let postal=null, cityText=null;

  // 1) JSON-LD
  doc.querySelectorAll('script[type="application/ld+json"]').forEach(s=>{
    try{
      const obj=JSON.parse(s.textContent);
      const addr=obj.address||obj.itemOffered?.address||obj.offers?.seller?.address;
      if(addr){ postal=postal||addr.postalCode||addr.postcode||addr.zip; cityText=cityText||addr.addressLocality||addr.city||addr.town; }
      if(!image && obj.image){ image=Array.isArray(obj.image)?obj.image[0]:(typeof obj.image==='string'?obj.image:null); }
    }catch(_){}
  });

  // 2) __INITIAL_STATE__
  if(!postal||!cityText){
    doc.querySelectorAll('script').forEach(s=>{
      const t=s.textContent||'';
      if(t.includes('__INITIAL_STATE__')){
        const start=t.indexOf('{'), end=t.lastIndexOf('}');
        if(start>=0&&end>start){
          const st=safeParse(t.slice(start,end+1));
          const a=st?.ad?.adAddress||st?.adInfo?.address||st?.adData?.address||null;
          if(a){ postal=postal||a.postalCode||a.postcode||a.zipCode; cityText=cityText||a.city||a.town||a.addressLocality; }
        }
      }
    });
  }

  // 3) Fallbacks
  if(!postal){
    const m = html.match(/"(?:postalCode|postcode|zip|zipCode|zipcode)"\s*:\s*"?(\d{5})"?/i);
    if(m) postal = m[1];
  }
  if(!postal){
    const ctx=/(\bplz\b|postleitzahl|postal(?:code)?|adresse|address|standort|ort|stadt|gemeinde|wohnort)/i;
    const matches=[...html.matchAll(/\b(\d{5})\b/g)].map(m=>({code:m[1],idx:m.index||0}));
    const filtered=matches.filter(({code,idx})=>{
      const left=Math.max(0,idx-100), right=Math.min(html.length,idx+100);
      const win=html.slice(left,right);
      const prev=html[idx-1]||'', next=html[idx+5]||'';
      const neighborsBad=/[-A-Za-z]/.test(prev)||/[-A-Za-z]/.test(next);
      const looksLikePrice=new RegExp(code+'[\\s\\/,\\.-]*€').test(win);
      const hasContext=ctx.test(win);
      return !neighborsBad && !looksLikePrice && hasContext;
    });
    if(filtered.length) postal=filtered[0].code;
  }

  // Preis
  let price=null;
  let pm= html.match(/"price":"([^"]+)"/i)
        ||html.match(/<meta[^>]+property=['"]product:price:amount['"][^>]*content=['"]([^'"]+)['"]/i)
        ||html.match(/([0-9][0-9\., ]* ?€)/);
  if(pm) price=pm[1].toString().trim();

  return {title,postal,cityText,price:formatPrice(price),image};
}

async function reversePLZ(postal){
  try{
    const url=`https://nominatim.openstreetmap.org/search?format=json&limit=1&addressdetails=1&countrycodes=de&postalcode=${encodeURIComponent(postal)}`;
    const res=await fetch(url,{headers:NOMINATIM_HEADERS});
    const j=await res.json();
    if(j&&j[0]){const a=j[0].address||{};const city=cityFromAddr(a);return {lat:+j[0].lat,lon:+j[0].lon,display:`${postal}${city?` ${city}`:''}`};}
  }catch(_){}
  return {lat:null,lon:null,display:postal};
}
async function geocodeTextOnce(text){
  try{
    const url=`https://nominatim.openstreetmap.org/search?format=json&limit=1&addressdetails=1&countrycodes=de&q=${encodeURIComponent(text)}`;
    const res=await fetch(url,{headers:NOMINATIM_HEADERS});
    const j=await res.json();
    if(j&&j[0]){const a=j[0].address||{};return {lat:+j[0].lat,lon:+j[0].lon,label:cityFromAddr(a)||text};}
  }catch(_){}
  return {lat:null,lon:null,label:text};
}

async function enrichListing(it,wantDetails=true){
  let lat=null,lon=null,price=formatPrice(it.price||""),postal=null,label=null,image=null,cityText=null;
  if(wantDetails){
    try{
      const html=await fetchViaProxy(it.url);
      const det=await parseListingDetails(html);
      if(det.title) it.title=det.title;
      if(det.price) price=det.price;
      if(det.image) image=det.image;
      postal=det.postal; cityText=det.cityText;
    }catch(e){ setStatus("Proxy/Parse-Fehler: "+e.message,true); }
  }
  if(postal){
    const g=await reversePLZ(postal);
    lat=g.lat;lon=g.lon;label=g.display;
  } else if(cityText){
    const g=await geocodeTextOnce(cityText+", Deutschland");
    lat=g.lat;lon=g.lon;label=g.label;
  }
  return {lat,lon,label,price,image,postal};
}

// Icons
const greenIcon=L.icon({iconUrl:"https://maps.google.com/mapfiles/ms/icons/green-dot.png",iconSize:[32,32],iconAnchor:[16,32]});
const blueIcon=L.icon({iconUrl:"https://maps.google.com/mapfiles/ms/icons/blue-dot.png",iconSize:[32,32],iconAnchor:[16,32]});
const redIcon=L.icon({iconUrl:"https://maps.google.com/mapfiles/ms/icons/red-dot.png",iconSize:[32,32],iconAnchor:[16,32]});

// ---------- ROBUSTER MOBILE-FETCH FÜR /api/inserate ----------
async function fetchApiInserate(q, plz, rKm) {
  const params = `query=${encodeURIComponent(q)}&location=${encodeURIComponent(plz)}&radius=${rKm}`;
  const tries = [
    `${window.location.origin}/api/inserate?${params}`,
    `/api/inserate?${params}`
  ];

  async function tryOnce(url, useMode) {
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), 10000);
    try{
      const resp = await fetch(url, {
        method: "GET",
        headers: { "Accept":"application/json" },
        cache: "no-store",
        credentials: "omit",
        ...(useMode ? { mode: "same-origin" } : {}),
        signal: ctrl.signal
      });
      clearTimeout(t);
      if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return await resp.json();
    }catch(e){
      clearTimeout(t);
      throw e;
    }
  }

  for(const url of tries){
    for(const useMode of [true,false]){
      try{ return await tryOnce(url,useMode); }catch(_){}
    }
  }
  await new Promise(r=>setTimeout(r,300));
  return tryOnce(tries[1], false);
}

// ---------- Start/Stop ----------
let running=false;
$("#btnRun").addEventListener("click",()=>{
  if(running){
    running=false;
    setStatus("Suche abgebrochen.", true);
    setProgressState("aborted", "Abgebrochen");
    $("#btnRun").textContent="Route berechnen & suchen";
  } else {
    run();
  }
});

async function run(){
running=true; $("#btnRun").textContent="Stop";
clearResults(); resetStatus();
setProgressState("active");           // animierte Streifen an
setProgress(0);
let totalFound = 0;                   // Trefferzähler für "Fertig"-Text
const q=$("#query").value.trim(); const rKm=10; const stepKm=50; // fix

  // Geocode Inputs
  async function getLonLatFromInput(inp){
    if(inp.dataset.lat&&inp.dataset.lon)return[Number(inp.dataset.lon),Number(inp.dataset.lat)];
    const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(inp.value)}`,{headers:NOMINATIM_HEADERS});
    const j=await res.json(); if(!j.length) throw new Error("Kein Treffer für "+inp.value);
    inp.dataset.lat=j[0].lat;inp.dataset.lon=j[0].lon; return[Number(inp.dataset.lon),Number(inp.dataset.lat)];
  }
  let startLL, zielLL;
  try{startLL=await getLonLatFromInput($("#start"));zielLL=await getLonLatFromInput($("#ziel"));}
catch(e){
  setStatus("Start/Ziel unklar: "+e.message,true);
  running=false;
  setProgressState("aborted","Abgebrochen");
  $("#btnRun").textContent="Route berechnen & suchen";
  return;
}

  // Markers
  const startLatLng=[Number($("#start").dataset.lat), Number($("#start").dataset.lon)];
  const zielLatLng=[Number($("#ziel").dataset.lat), Number($("#ziel").dataset.lon)];
  L.marker(startLatLng,{icon:blueIcon}).addTo(resultMarkers).bindPopup("Start");
  L.marker(zielLatLng,{icon:redIcon}).addTo(resultMarkers).bindPopup("Ziel");

  try{
    const res=await fetch(`https://api.openrouteservice.org/v2/directions/driving-car/geojson`,{
      method:"POST",headers:{"Content-Type":"application/json","Authorization":ORS_APIKEY},
      body:JSON.stringify({coordinates:[startLL,zielLL]})
    });
    const data=await res.json();
    const coords=data.features[0].geometry.coordinates;
    if(routeLayer) map.removeLayer(routeLayer);
    routeLayer=L.polyline(coords.map(c=>[c[1],c[0]]),{weight:5,color:'#1e66f5'}).addTo(map);
    map.fitBounds(routeLayer.getBounds());

    // Route sampling
    function sampleEveryMeters(coords,stepMeters){
      const out=[];let acc=0,prev=coords[0];
      const toMeters=([lon1,lat1],[lon2,lat2])=>{
        const dx=(lon2-lon1)*111320*Math.cos((lat1+lat2)*0.5*Math.PI/180);
        const dy=(lat2-lat1)*110540;return Math.hypot(dx,dy);
      };
      for(let i=1;i<coords.length;i++){
        const d=toMeters(prev,coords[i]);acc+=d;
        if(acc>=stepMeters){acc=0;prev=coords[i];out.push(coords[i]);}
      }
      return out;
    }
    const samples=sampleEveryMeters(coords,stepKm*1000);

    let done=0; const seen=new Set();
    for(const [lonS,latS] of samples){
      if(!running) break; done++;
setProgress(Math.round(done/samples.length*100));

      // Reverse → PLZ
      let plz=null;
      try{
        const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latS}&lon=${lonS}&format=jsonv2&zoom=10&addressdetails=1`,{headers:NOMINATIM_HEADERS});
        const j=await r.json(); plz=j?.address?.postcode||null;
      }catch(_){}
      if(!plz) continue;

      // Inserate
      let items=[];
      try{
        const j = await fetchApiInserate(q, plz, rKm);
        items = j?.data || [];
      }catch(e){
        setStatus(`API-Netzwerkfehler für PLZ ${plz}: ${e.message}`, true);
      }
      setStatus(`PLZ ${plz}: ${items.length} Treffer`);

      for(const it of items){
        if(seen.has(it.url)) continue; seen.add(it.url);
        let enrich={}; try{ enrich=await enrichListing(it,true);}catch(_){}
        if(!enrich.lat||!enrich.lon) continue;

        // Filter: max 10km Luftlinie zu Route
        let minDist = Infinity;
        for(const [lon,lat] of samples){
          const d = haversine(lat,lon,enrich.lat,enrich.lon);
          if(d < minDist) minDist = d;
          if(minDist <= 10000) break;
        }
        if(minDist>10000) continue;
        totalFound++;

        const loc=enrich.label||plz||"?";
        const price=enrich.price;
        // Card-HTML für Galerie
        const cardHtml = `
          <a href="${it.url}" target="_blank" rel="noopener">
            ${enrich.image?`<img src="${enrich.image}" alt="">`:''}
            <strong>${it.title}</strong>
          </a>
          <div class="muted">${price}</div>
        `;

        // Ergebnisliste (Galerie-Gruppen)
        addResultGalleryGroup(loc, cardHtml);

        // Marker-Popup (Liste)
        const popupHtml = `<a href="${it.url}" target="_blank"><strong>${it.title}</strong></a><br>${price}<br>${loc}${enrich.image?`<br><img src="${enrich.image}" style="max-width:180px;border-radius:8px">`:''}`;
        addListingToClusters(enrich.lat, enrich.lon, popupHtml, "Anzeigen in der Nähe");
      }
    }
setStatus("Fertig.");
setProgress(100);
setProgressState("done", `Fertig – ${totalFound} Inserate`);
}catch(e){
  setStatus(e.message,true);
  setProgressState("aborted","Abgebrochen");
}
running=false; $("#btnRun").textContent="Route berechnen & suchen";
}
</script>
</body>
</html>
